# 360 image and video manipulation

## Equirectangular to Cubemap

To convert any equirectangular image to cubemap, you'll need `imagemagick`, `exiftool` and `convert360`, at the end how to install this dependencies. `convert360` requires the input image to be png.

1. Convert the equirectangular image to a flat PNG file
```sh
magick equirectangular.tif -flatten -alpha off equirectangular.png
```

2. Get the image width, to devide it into 4 to get the cube size
```sh
exiftool -s -s -s -ImageWidth equirectangular.png
```

3. Convert the png file to cuebemap with `convert360`
```sh
convert360 -i equirectangular.png -o cubemap.png -s 2992 2992 -it equirectangular -ot cubemap
```

4. Slice the cubemap into its different pieces
```sh
magick cubemap.png -crop 2992x2992 +repage output_%d.tif
```

5. Rename files to its cube face
```sh
mv output_1.tif Left.tif
mv output_0.tif Right.tif
mv output_2.tif Up.tif
mv output_3.tif Down.tif
mv output_4.tif Front.tif
mv output_5.tif Back.tif
```

## Cubemap to Equirectangular

For this task, we need Hugin, see dependencies at the end.

1. Create a `.pto` as in the following example, and set the filename of each cube face, in this example the images are `Back.tif`, `Front.tif`, `Down.tif`, `Left.tif`, `Right.tif`, `Up.tif`, also set the dimensions of the final equirectangular image, and the dimensions of each side of the cube.

> In the following example of a `.pto` file, the final equirectangular image has a width of `16384px` by a height of `8192px`, based on a `4096px` cube size. To get the width, we multiply `4` by the cube size, and for the height, `2` by the cube size. Hugin has another "optimized" version of this calculation, where it multiplies the width of the cube by Ï€ (pi), rounds up to the nearest integer, and then divides the result by two to get the height.

Sample `cubemap.pto`
```
p f2 w16384 h8192 v360  k0 E0 R0 n"TIFF_m c:LZW r:CROP"
m i0

i w4096 h4096 f0 v90 Ra0 Rb0 Rc0 Rd0 Re0 Eev0 Er1 Eb1 r0 p0 y0 TrX0 TrY0 TrZ0 Tpy0 Tpp0 j0 a0 b0 c0 d0 e0 g0 t0 Va1 Vb0 Vc0 Vd0 Vx0 Vy0  Vm5 n"Back.tif"
i w4096 h4096 f0 v=0 Ra=0 Rb=0 Rc=0 Rd=0 Re=0 Eev0 Er1 Eb1 r0 p-90 y180 TrX0 TrY0 TrZ0 Tpy0 Tpp0 j0 a=0 b=0 c=0 d=0 e=0 g=0 t=0 Va=0 Vb=0 Vc=0 Vd=0 Vx=0 Vy=0  Vm5 n"Down.tif"
i w4096 h4096 f0 v=0 Ra=0 Rb=0 Rc=0 Rd=0 Re=0 Eev0 Er1 Eb1 r0 p0 y180 TrX0 TrY0 TrZ0 Tpy0 Tpp0 j0 a=0 b=0 c=0 d=0 e=0 g=0 t=0 Va=0 Vb=0 Vc=0 Vd=0 Vx=0 Vy=0  Vm5 n"Front.tif"
i w4096 h4096 f0 v=0 Ra=0 Rb=0 Rc=0 Rd=0 Re=0 Eev0 Er1 Eb1 r0 p0 y90 TrX0 TrY0 TrZ0 Tpy0 Tpp0 j0 a=0 b=0 c=0 d=0 e=0 g=0 t=0 Va=0 Vb=0 Vc=0 Vd=0 Vx=0 Vy=0  Vm5 n"Left.tif"
i w4096 h4096 f0 v=0 Ra=0 Rb=0 Rc=0 Rd=0 Re=0 Eev0 Er1 Eb1 r0 p0 y-90 TrX0 TrY0 TrZ0 Tpy0 Tpp0 j0 a=0 b=0 c=0 d=0 e=0 g=0 t=0 Va=0 Vb=0 Vc=0 Vd=0 Vx=0 Vy=0  Vm5 n"Right.tif"
i w4096 h4096 f0 v=0 Ra=0 Rb=0 Rc=0 Rd=0 Re=0 Eev0 Er1 Eb1 r0 p90 y180 TrX0 TrY0 TrZ0 Tpy0 Tpp0 j0 a=0 b=0 c=0 d=0 e=0 g=0 t=0 Va=0 Vb=0 Vc=0 Vd=0 Vx=0 Vy=0  Vm5 n"Up.tif"

v Ra0
v Rb0
v Rc0
v Rd0
v Re0
v Vb0
v Vc0
v Vd0
v Eev1
v r1
v p1
v y1
v Eev2
v r2
v p2
v y2
v Eev3
v r3
v p3
v y3
v Eev4
v r4
v p4
v y4
v Eev5
v r5
v p5
v y5
v

```

2. Use `nona` to prepare the image for stitching
```sh
nona -o pano -m TIFF_m -z LZW pano.pto
```

3. Use `verdandi` to blend the images
```sh
verdandi \
pano0000.tif \
pano0001.tif \
pano0002.tif \
pano0003.tif \
pano0004.tif \
pano0005.tif \
-o pano_equirectangular.tif
```

## Download a Facebook 360 image
Check the `360` directory for the Bash and Python scripts.
1. View the 360 image in a webbrowser by clicking in it until it is in its maximum size, NOT full screen.
2. Open the browser Developer Tools and reload the page.
3. In the tab Network, righ clic any requested file, select `Copy` and then `Copy all as cURL`.
4. Paste the curls into a `curls.txt` file.
5. Run `curls2uris.py`.
6. Run `aria2c` to download the images.
7. Join the images with `joinmosaic.sh`

```sh
./curls2uris.py curls.txt downloadfolder
cd downloadfolder && aria2c -j 16 --continue=true --auto-file-renaming=false -i uris.txt && cd ..
mkdir mosaic && ./joinmosaic.sh ./downloadfolder ./mosaic
./c2e.sh ./mosaic ./finalimage.tif 
tif2jpg.sh finalimage.tif finalimage.jpg
```

A simple script can be `./fbdown.sh curls.txt panoname`

## Dependencies

### ImageMagick and Exiftool
```sh
brew install imagemagick exiftool aria2
```

### `convert360`
1. Install `conda` to have a working Python enviroment
```sh
curl -L -O "https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-$(uname)-$(uname -m).sh"
bash Miniforge3-$(uname)-$(uname -m).sh
```
It is recomended to restart the terminal, then, install `convert360`

2. Install `convert360` with `pip`
```sh
pip install convert360
```

3. For reasons that I don't understand, the `convert360` script has a path from the wrong interpreter, so with `nano`:
```sh
nano ~/miniforge3/bin/convert360
```

Replace the interpreter, from this:

```sh
#!/home/mateus/dev/still360/env/bin/python
```

To this:
```sh
#!/usr/bin/env python
```

# Hugin
The official download links for Hugin are obsolete, user Dannephoto provided a more recent builds for Intel and Apple Silicon macs:
https://bitbucket.org/Dannephoto/hugin/downloads/

> macOS "protects" its users from "unwanted binaries" that are downloaded, a trick to avoid this issues is to use a `cat Hugin-2023.0.0_GPUFIX.dmg > Hugin-2023.0.0_GPUFIX_noquarantine.dmg` and then install the DMG files.
